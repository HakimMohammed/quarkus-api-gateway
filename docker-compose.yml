networks:
  kong-net:
    driver: bridge
  services-net:
    driver: bridge

volumes:
  clients_data:
  products_data:
  kong-datastore:

services:

  # --- Databases for microservices ---
  postgres-clients:
    image: postgres:16-alpine
    container_name: postgres-clients
    environment:
      POSTGRES_DB: clients_db
      POSTGRES_USER: clients_user
      POSTGRES_PASSWORD: clients_pass
    volumes:
      - clients_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    networks:
      - services-net
    restart: unless-stopped

  postgres-products:
    image: postgres:16-alpine
    container_name: postgres-products
    environment:
      POSTGRES_DB: products_db
      POSTGRES_USER: products_user
      POSTGRES_PASSWORD: products_pass
    volumes:
      - products_data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    networks:
      - services-net
    restart: unless-stopped

  # --- Quarkus microservices ---
  clients-service:
    image: quarkus/customer-service:latest
    container_name: clients-service
    build:
      context: ./customer-service
      dockerfile: src/main/docker/Dockerfile.jvm
    environment:
      DB_URL: jdbc:postgresql://postgres-clients:5432/clients_db
      DB_USER: clients_user
      DB_PASSWORD: clients_pass
    depends_on:
      - postgres-clients
    networks:
      - services-net
      - kong-net  # so Kong can reach it

  products-service:
    image: quarkus/product-service:latest
    container_name: products-service
    build:
      context: ./product-service
      dockerfile: src/main/docker/Dockerfile.jvm
    environment:
      DB_URL: jdbc:postgresql://postgres-products:5432/products_db
      DB_USER: products_user
      DB_PASSWORD: products_pass
    depends_on:
      - postgres-products
    networks:
      - services-net
      - kong-net  # so Kong can reach it

  hello-first:
    image: quarkus/hello-first:latest
    container_name: hello-first
    build:
      context: ./hello-first
      dockerfile: src/main/docker/Dockerfile.jvm
    ports:
      - "8099:8080"
    networks:
      - kong-net
  
  hello-second:
    image: quarkus/hello-second:latest
    container_name: hello-second
    build:
      context: ./hello-second
      dockerfile: src/main/docker/Dockerfile.jvm
    networks:
      - kong-net

  # --- Kong ---
  kong-database:
    image: postgres:13
    container_name: kong-database
    environment:
      POSTGRES_USER: kong
      POSTGRES_DB: kong
      POSTGRES_PASSWORD: kongpass
    ports:
      - "5436:5432"  # careful: avoid conflict with other postgres? can remap
    networks:
      - kong-net
    volumes:
      - kong-datastore:/var/lib/postgresql/data
    restart: unless-stopped

  kong-migration:
    image: kong:latest
    container_name: kong-migration
    depends_on:
      - kong-database
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kongpass
    command: kong migrations bootstrap
    networks:
      - kong-net
    restart: on-failure

  kong:
    image: kong:latest
    container_name: kong
    depends_on:
      - kong-database
      - kong-migration
      - clients-service
      - products-service
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kongpass
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_ADMIN_GUI_LISTEN: 0.0.0.0:8002
      # Tells Kong to determine the real client IP from the X-Real-IP header
      # Just to test IP-Restriction plugin
      KONG_REAL_IP_HEADER: X-Real-IP
      KONG_TRUSTED_IPS: 0.0.0.0/0
    ports:
      - "8000:8000"
      - "8443:8443"
      - "8001:8001"
      - "8444:8444"
      - "8002:8002"
    networks:
      - kong-net
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 10s
      retries: 10
    restart: unless-stopped

  # General Documentation UI for all services
  swagger-ui:
    image: swaggerapi/swagger-ui
    container_name: swagger-ui
    environment:
      URLS: "[ 
        { url: 'http://localhost:8000/api/clients/openapi', name: 'Clients Service' },
        { url: 'http://localhost:8000/api/products/openapi', name: 'Products Service' }  ]"
    networks:
      - kong-net
  
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - kong-net
      - services-net
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    networks:
      - kong-net
      - services-net
    restart: unless-stopped